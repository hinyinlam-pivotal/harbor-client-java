# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout harbor-java-client repo for generation script
        uses: actions/checkout@v2
        with:
          path: harbor-java-client 
      
      - name: Checkout official Harbor repo for swagger.yaml
        uses: actions/checkout@v2
        with:
          repository: goharbor/harbor 
          path: harbor
          fetch-depth: 0   

      # Runs a single command using the runners shell
      - name: Showing working directory
        working-directory: .
        run: |
          ls -l

      # Runs a set of commands using the runners shell
      - name: Showing Java SDK Client history
        working-directory: harbor-java-client
        run: |
          ls -l
          git log

      # Runs a set of commands using the runners shell
      - name: Showing goharbor/harbor History
        working-directory: harbor
        run: |
          echo "====================="
          echo "====Describe latest tag we are going to build with===="
          git describe --abbrev=0 --tags
          
          echo "====What's the news===="          
          git log -n 1
          echo "====================="
        
      - name: Checkout latest release tag and copy swagger definition
        working-directory: harbor
        run: |
          git checkout tags/`git describe --abbrev=0 --tags` -b `git describe --abbrev=0 --tags`
          cp  api/v2.0/swagger.yaml ../
          ls ../
          
      - name: Download and install OpenAPIGenerator
        run: |
          mkdir -p ~/bin/openapitools
          curl https://raw.githubusercontent.com/OpenAPITools/openapi-generator/master/bin/utils/openapi-generator-cli.sh > ~/bin/openapitools/openapi-generator-cli
          chmod u+x ~/bin/openapitools/openapi-generator-cli
          export PATH=$PATH:~/bin/openapitools/
          ~/bin/openapitools/openapi-generator-cli version
          
      - name: Download and OpenAPI Generator
        run: |
          export PATH=$PATH:~/bin/openapitools/
          openapi-generator-cli version
          
      - name: Generate API SDK using OpenAPI Generator
        run: |
          export PATH=$PATH:~/bin/openapitools/
          openapi-generator-cli generate -i swagger.yaml -g java --api-package  io.goharbor.api --model-package io.goharbor.model  --package-name io.goharbor -p artifactId=harbor-java-client,groupId=io.goharbor  --output ./generated-java-client/
         
    
          
